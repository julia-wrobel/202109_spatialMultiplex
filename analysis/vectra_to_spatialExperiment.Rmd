---
title: "Converting Vectra data to spatialExperiment Objects"
hitheme: tomorrow
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
highlighter: highlight.js
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE,
                      include = FALSE)
```

## Overview 

This document provides info on how to convert Vectra data into a `spatialExperiment` object.

* Should have conversion functions for `tiff` files and `.txt` tabular data


## Correspondence between ST and MI

The `spatialExperiment` object has a particular structure. Here I explain the correspondence between `spatialExperiment` slots for typical ST data, and how we expect it to behave for MI data.


* `assays`: contains expression counts
  * columns: cells
  * rows: genes
  * In our case, columns are cells and rows are markers
    * assays contains mean/median expression values for each marker and each cell
    * Generally we have mean at the total cell, membrane, and nuclei level. Do we want to store this data in wide form (all in the assays) or long form? I think wide.
    * What types of assays would be useful for our data?
      * Maybe an assay for nuclei, assay for total cells, assay for membrane?
      * Ask Cole how he applies his method and what the data structure is
* `rowData`: "feature metadata"
  * For us, this would contain information about markers... maybe marker type (phenotypic vs. functional)?
* `colData`: contains info about cells
  * For us this is phenotype, tissue category, cell shape, cell min/max axis, etc
* `spatialCoords`: stores spatial coordinates
* `imgData`: contains image data. Our images might be too big for this.


## Convert `txt` to `spe`


I wrote a function called `readVectraTable.R` for converting Vectra `.txt` data to an `spe` object. You provide the function with a directory that has one or multiple `.txt` files from a Vectra instrument and combines into one `spe` object.

* Need to assess if I should change what is stored in `assays`.

### Lung cancer data

This is a subset of the data from [Johnson et. al.](https://www.semanticscholar.org/paper/Cancer-cell-specific-MHCII-expression-as-a-of-the-Johnson-Boland/310b4eb9d9fe2ec2254004e0780c4b722ba1fe5d).

```{r, echo = TRUE}
library(tidyverse)
library(SpatialExperiment)

source(here::here("source", "readVectraTable.R"))


spe = readVectraTable(sample_path = here::here("data", "tabular"),
                clean_names = TRUE)
```

### Phenoptr data

This data is available in the [`phenoptrExamples` package](https://akoyabio.github.io/phenoptrExamples/index.html) from Akoya Biosciences. Nine images taken from three samples of (also) lung cancer tissue.

```{r}
path <- system.file("extdata", "samples", package = "phenoptrExamples")

spe_phenoptr = readVectraTable(sample_path = path)
```


## Downstream Analysis

Do some downstream analysis already possible with the `SpatialExperiment` package.

## Questions

* What if I want to add in clinical data?
* Do we need to call assay 'counts' or do we want to call it something else?
* What goes in `assays`? Min, mean, max, std dev, total all together or each as a separate assay?
  * See how Cole uses this information
* Where are IDs stored? Does downstream manipulation seem to work?
* What is the unique image ID? Slide ID? Patient ID? are these consistent across Vectra datasets?   

## To Do

* Add rownames with subject-image-cell-id identifier
* Decide where to put "other" variables like distances, and nearest neighbor distances as well if calculated

```{r, echo = TRUE, eval = FALSE}
# put the distance from tissue category edge in spatial vars?
# maybe another assay?
other = c("Category Region ID", "Distance from Tissue Category Edge (microns)",
            )
```

* Add image data?
* Add examples with clinical data?
* We may need to convert area characteristics from pixels to microns
  * See `phenoptr::read_cell_seg_data()` about this
  

### Images

I plan to write a function to convert images and segmentations to tabular format. Images might be too large for storage as part of a spatial experiment object.
